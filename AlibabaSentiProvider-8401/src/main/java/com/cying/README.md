# 一、流量控制

![image-20200426222039556](http://narpro.top/img/image-20200426222039556.png)

- 资源名：url 地址
- 针对来源：
- 阈值类型：
  - QPS：每秒钟允许请求的次数
  - 线程数：服务器内部能同时处理的线程数
- 单机阈值：对阈值类型设置数量
- 是否集群
- 流控模式：
  - 直接：对资源本身
  - 关联：资源本身繁忙，从而限制指定关联的资源
- 流控效果：
  - 快速失败：一旦请求超过阈值（每秒请求次数超出，或者同时需要的线程数多余设置的线程数）则直接报错
  - Warm up：让服务器能承载的阈值上限逐渐上升
  - 排队等待：不管来多少请求，不会拒绝，只不过一个一个处理

## 1.1 QPS-直接-快速失败

一旦一秒内请求次数超过 QPS 能够承载的阈值，则直接服务限流【`Blocked By Sentinel(flow limiting)`】

## 1.2 线程数-直接-快速失败

一旦同时请求的线程数超过了设置的线程数，则直接服务限流

## 1.3 QPS-关联-快速失败

如果 A 的流控关联了 B，而 A 的请求超出了所承受的最高阈值，则 B 被限流。比如 A 是支付，B 是下单，A 的支付都忙不过来，那 B 的下单利索当然要被迫限流等一等

## 1.4 QPS-直接-warm up

选择后会出现新的文本框

![image-20200426224259471](http://narpro.top/img/image-20200426224259471.png)

冷因子默认是 3，设阈值为 10，预热时长为 5，则一开始能承载的最大阈值为 10/3=3 个请求，5 秒之后，渐渐的能承载 10 个

## 1.5 QPS-直接-排队等待

根据 QPS 的阈值，确定每秒处理多少个请求

# 二、熔断降级

![image-20200426225356181](http://narpro.top/img/image-20200426225356181.png)

- 资源名：url 地址
- 降级策略：以下均是窗口期内通过的请求 >= 5 才生效
  - RT：平均响应时间（秒级），超出阈值生效。RT 最大 4900
    可通过 `-Dcsp.sentinel.statistic.max.rt=?` 配置更高的
  - 异常比例：异常出现的比例（秒级），超过阈值生效
  - 异常数：异常出现的次数（秒级），查过阈值生效

## 2.1 RT

设 RT 为 200ms，时间窗口为 1，程序需要执行时间 1s，则发送 5 次及以上请求，这些请求还是会继续执行，但因为时间超过了 200ms，那么在下一秒将会处于降级期

## 2.2 异常比例

设异常比例为 0.2，时间窗口为 1 ，则发送 5 次及以上请求，在一秒内一旦有 20% 的请求出错，那么在下一秒将会处于降级期，而且此处只进行服务降级，即请求异常超过一定比例就降级，并不会处理异常，所以如果在没达到条件的情况下，程序抛出异常，异常将会按照规定返回给前端

## 2.3 异常数

设异常数为 10，时间窗口为 1 ，则发送 5 次及以上请求，在一分钟内，一旦有 10 个请求抛出异常，那么在下一秒内会处于降级期

# 三、热点

![image-20200426233125554](http://narpro.top/img/image-20200426233125554.png)

- 资源名：注解中的指定名
- 限流模式
- 参数索引：注解所在方法的第几个参数
- 单位阈值：允许的请求数
- 统计窗口时长

```java
    @GetMapping(value = "/hotkey")
    @SentinelResource(
            value = "hotkey",
            blockHandler = "hotkeyHandler"
    )
    public CommonResult<String> hotKey(
            @RequestParam(value = "p1", required = false) String p1,
            @RequestParam(value = "p2", required = false) String p2
    ) {
        return new CommonResult<String>(200, "p1: " + p1 + ", p2: " + p2);
    }

    public CommonResult<String> hotkeyHandler(
        String p1, 
        String p2, 
        BlockException e
    ) {
        return new CommonResult<String>(
            200, 
            "p1: " + p1 + ", p2: " + p2, 
            e.getMessage()
        );
    }
```

若要检测 p1，即第 0 个参数

资源名为 hotkey，参数索引为 0，单位阈值为 1，统计窗口时长为 1，则当访问 /hotkey 时，带有 p1 的情况下，1 秒钟只能发送 1 次请求，否则就会进入 hotkeyHandler 方法进行降级处理

---

当热点配置成功后还能继续追加高级操作

![image-20200426235645914](http://narpro.top/img/image-20200426235645914.png)

- 参数类型：只支持 8 个基本类型和 String
- 参数值：可以额外考虑的值
- 限流阈值

设参数类型为 String，参数值为 250，限流阈值为 10，其他与上面相同，则 p1 值是 250 时，每秒要达到 10 次后才降级